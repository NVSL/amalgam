<!DOCTYPE html>
<html>    
<head>
  <title>Weight Scale Version 1</title>
  
  <link rel="stylesheet" media="screen" href="https://fontlibrary.org/face/segment7" type="text/css"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic">
  <link rel='stylesheet prefetch' href='https://cdn.gitcdn.link/cdn/angular/bower-material/v1.1.6/angular-material.css'>
  <link href="./styles.css" rel="stylesheet" />

  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
  <script src='https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-animate.min.js'></script>
  <script src='https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-route.min.js'></script>
  <script src='https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-aria.min.js'></script>
  <script src='https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-messages.min.js'></script>
  <script src='https://s3-us-west-2.amazonaws.com/s.cdpn.io/t-114/svg-assets-cache.js'></script>
  <script src='https://cdn.gitcdn.link/cdn/angular/bower-material/v1.1.6/angular-material.js'></script>

</head>
<body>
    <div ng-app="myApp" ng-controller="myCtrl">

      <!-- Phisical Web Components -->
      <physical-weight-sensor ng-model="productWeight"></physical-weight-sensor>
      <physical-span ng-bind="productName+'\nTotal: '+((productWeight-zeroWeight-currentTare)*productPrice | number : 2)"></physical-span>

      <!-- Weight Scale Interface -->
      <div id="scale" class="light">
        <div class="display">

          <div id="elements" layout="row">

            <div class="weight" flex>
                  <div class="text">
                    <span>Weight g</span>
                    <span class="tare" ng-style="tareStyle">TARE</span>
                  </div>
                  <div class="digits">
                    <span ng-bind="(productWeight-zeroWeight-currentTare) | number : 2"></span>
                  </div>
            </div>

            <div class="price" flex>
                  <div class="text">
                    <span>Price $</span>
                  </div>
                  <div class="digits" >
                    <span ng-bind="productPrice | number : 2"></span>
                  </div>
            </div>

            <div class="total" flex>
              <div class="text" >
                <span>Total $</span>
              </div>
              <div class="digits">
                <span ng-bind="(productWeight-zeroWeight-currentTare)*productPrice | number : 2"></span>
              </div>
            </div>

          </div>

        </div>
      </div>

      <section layout="row">
        <!-- NAV BAR -->
        <md-sidenav class="sidenav" md-component-id="left" md-is-locked-open="true" flex="" >
          <md-button class="md-raised" ng-click="zeroClick()">ZERO</md-button>
          <md-button class="md-raised" ng-click="tareClick()">TARE</md-button>
        </md-sidenav>
        <!-- PRODUCTS -->
        <div class="scroll-container" flex="">
          <md-grid-list md-cols="1" md-row-height="170px" md-gutter="1em">
            <md-grid-tile ng-repeat="tile in tiles" ng-click="productClick($index)">
              <img ng-src="{{tile.image}}" alt="beer" layout-fill>
              <md-grid-tile-footer class="productTitle">
                <div layout="row">
                  <span class="productText" flex="">{{tile.text}}</span>
                  <span class="productPrice" flex="">${{tile.price}}</span>
                </div>
              </md-grid-tile-footer>
            </md-grid-tile>
          </md-grid-list>
        </div>
      </section>

    </div>

    <script>

        // ## Linuxduino Firmware

        var Linuxduino = require("linuxduino");
        var Serial = null;

        const DOUT = 2;
        const CLK  = 3;
        const CALIBRATION_FACTOR = 21680;
        var OFFSET = 0;

        // ## Load Cell

        function shiftIn(dataPin, clockPin) {
          var value = 0;
          var i;

          for (i = 0; i < 8; ++i) {
            Linuxduino.digitalWrite(clockPin, Linuxduino.HIGH);
            Linuxduino.digitalWrite(clockPin, Linuxduino.LOW);
            value |= Linuxduino.digitalRead(dataPin) << (7 - i);
          }                                   
          return value;
        }

        function scale_init (pin_data, pin_clk) {
          Linuxduino.pinMode(pin_clk, Linuxduino.OUTPUT);
          Linuxduino.pinMode(pin_data, Linuxduino.INPUT);
          Linuxduino.digitalWrite(pin_clk, Linuxduino.LOW);
        }

        function scale_read(pin_data, pin_clk) {
          
          var value = 0;
          var data = [0,0,0];
          var filler = 0x00;

          while ( !(Linuxduino.digitalRead(pin_data) == 0) );

          // pulse the clock pin 24 times to read the data
          data[2] = shiftIn(pin_data, pin_clk);
          data[1] = shiftIn(pin_data, pin_clk);
          data[0] = shiftIn(pin_data, pin_clk);

          // set the channel and the gain factor for the next reading using the clock pin
          var GAIN = 1; // It can be 1, 2 or 3
          for (var i = 0; i < GAIN; i++) {
            Linuxduino.digitalWrite(pin_clk, Linuxduino.HIGH);
            Linuxduino.digitalWrite(pin_clk, Linuxduino.LOW);
          }

          // Return -1 if any of the values is not correct (In case of node)
          if (data[0] == 255 || data[1] == 255 || data[2] == 255) {
            return -1;
          }

          // Replicate the most significant bit to pad out a 32-bit signed integer
          if (data[2] & 0x80) {
            filler = 0xFF;
          } else {
            filler = 0x00;
          }

          // Construct a 32-bit signed integer
          value = filler << 24
              | data[2] << 16
              | data[1] << 8
              | data[0];

          return value;
        }

        function scale_read_average (pin_data, pin_clk, times) {
          var sum = 0;
          for (var i = 0; i < times; i++) {
            var value = scale_read(pin_data, pin_clk);
            if (value == -1) {
              i--; // Try again
              //console.log("Skip");
            }
            sum += value;
          }
            
          return sum / times;
        }

        function scale_get_offset (pin_data, pin_clk) {
          return scale_read_average(pin_data, pin_clk, 10);
        }

        function scale_get_weight(pin_data, pin_clk, offset, scale) {
          var raw_weight = (scale_read_average(pin_data, pin_clk, 2) - offset);
          return (raw_weight / scale);
        }

        // ## LCD Display

        function writeLCDText (Serial, text) {

          if (Serial == null) {
            console.log("Serial is null");
            return;
          }

          // Clear Display
          Serial.write_byte(0xFE);  // send the special command
          Serial.write_byte(0x01);  // send the clear screen command

          var data = text.split("\n");

          if (data[0] != undefined) {
            // Move cursor to beginning of first line
            Serial.write_byte(254); 
            Serial.write_byte(128);
            Serial.write(data[0]);
          }

          if (data[1] != undefined) {
            // Move cursor to beginning of the second line
            Serial.write_byte(254); 
            Serial.write_byte(192);
            Serial.write(data[1]);
          }

        }

        // ## Linuxduino Main

        Linuxduino.onRuntimeInitialized = function() {
          console.log('wsm file loaded');

          // ## Serial
          Serial =  new Linuxduino.Serial();
          Serial.begin("/dev/ttyAMA0", 9600);
          writeLCDText(Serial, ""); // Clear Display

          // ## Load Cell Setup
          scale_init (DOUT,CLK);
          // Assuming no weight at the begining
          OFFSET = scale_get_offset (DOUT, CLK);
          console.log("OFFSET = " + OFFSET);

        }

        // ## Angular app

        var app = angular.module('myApp', ['ngMaterial']);
        app.controller('myCtrl', function($scope, $compile, $interval, $timeout) {

          $scope.productWeight = 0;
          $scope.zeroWeight = 0;
          $scope.productPrice = 0;
          $scope.currentTare = 0;
          $scope.productName = "";
          $scope.tareStyle = {'visibility': 'hidden'};
          var hardwareWeight = 0;
          
          

          $scope.tiles = [
            { text: 'Chicken Box', price:25, image: 'img/chicken.jpg' },
            { text: 'Meat', price:8, image: 'img/meat.jpg'},
            { text: 'Avocado', price:1.75, image: 'img/avocado.jpg'},
            { text: 'Tomato', price:0.85, image: 'img/tomato.jpg'},
            { text: 'Limes', price:0.72, image: 'img/limes.jpg'}
          ];

          $scope.productClick = function (index) {
            console.log("Product Click"+$scope.tiles[index].text);
            $scope.productName = $scope.tiles[index].text;
            $scope.productPrice = $scope.tiles[index].price;
          }

          $scope.zeroClick = function() {
            console.log("Zero Click");
            $scope.zeroWeight = $scope.productWeight;
          }

          $scope.tareClick = function() {
            if ($scope.tareStyle.visibility === 'hidden') {
              $scope.tareStyle = {'visibility': 'visible'};
              $scope.currentTare = $scope.productWeight - $scope.zeroWeight;
            } else {
              $scope.tareStyle = {'visibility': 'hidden'};
              $scope.currentTare = 0;
            }
            console.log("Weight:"+ $scope.productWeight);
            console.log("Tare:"+ $scope.currentTare);
          }

        });

        // ## Angular webcomponents

        app.directive("physicalWeightSensor", function() {
          return {
            require: 'ngModel',
            link: function(scope, element, attributes, ngModel) {

              // var ngvalue = ngModel.$viewValue; // Get ngModel Value
              window.setInterval(function () {

                var weight = scale_get_weight(DOUT, CLK, OFFSET, CALIBRATION_FACTOR); //Math.random();
                ngModel.$setViewValue(weight);
                ngModel.$render();
                
              }, 500);
            }
          };
        });

        app.directive("physicalSpan", function() {
          return {
              link: function(scope, element, attrs) {

                if(angular.isUndefined(attrs.ngBind)) {
                  return;
                }

                // Hide the span Text by default
                element.css({'display': 'none'});

                scope.$watch(attrs.ngBind, function(newValue, oldValue) {
                  // Set initial value
                  if (newValue === oldValue) return; // We don't want the initial value anyway
                  console.log("LCD: "+newValue);
                  writeLCDText(Serial, newValue.toString());

                });
              }
          };
        });

    </script>
</body>
</html>

